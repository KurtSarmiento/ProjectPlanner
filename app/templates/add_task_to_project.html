<!DOCTYPE html>
<html lang="en">
<head>
    </head>
<body>
    <header>
        </header>

    <main>
        <h2>Add New Task to Project: {{ project.name }}</h2>

        <ul class="flashes">
            {% with messages = get_flashed_messages(with_categories=true) %}
              {% for category, message in messages %}
                <li class="{{ category }}">{{ message }}</li>
              {% endfor %}
            {% endwith %}
        </ul>

        <form method="POST" action="{{ url_for('main.add_task_to_project', project_id=project.id) }}">
            <label for="task_name">Task Name:</label><br>
            <input type="text" id="task_name" name="task_name" required><br><br>

            <label for="start_date">Start Date:</label><br>
            <input type="date" id="start_date" name="start_date"><br><br>

            <label for="end_date">End Date:</label><br>
            <input type="date" id="end_date" name="end_date"><br><br>

            <label for="progress">Progress (%):</label><br>
            <input type="number" id="progress" name="progress" min="0" max="100" value="0" required><br><br>

            <label for="status">Status:</label><br>
            <select id="status" name="status" required>
                <option value="To Do">To Do</option>
                <option value="In Progress">In Progress</option>
                <option value="Completed">Completed</option>
                <option value="Blocked">Blocked</option>
            </select><br><br>

            <label for="dependencies">Dependencies (tasks from your projects):</label><br>
            <select id="dependencies" name="dependencies" multiple>
                {% for task_option in all_tasks %}
                    <option value="{{ task_option.id }}">{{ task_option.name }} ({{ task_option.project.name }})</option>
                {% endfor %}
            </select><br><br>

            <button type="submit">Add Task</button>
        </form>

        <script>
            const form = document.querySelector('form');
            const project_id = {{ project.id }};

            form.addEventListener('submit', async function(event) {
                event.preventDefault(); // Prevent default full page reload

                const formData = new FormData(form);
                const actionUrl = form.action;

                try {
                    const response = await fetch(actionUrl, {
                        method: 'POST',
                        body: formData,
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest', // Indicate AJAX request
                        }
                    });
                    const data = await response.json();

                    const flashContainer = document.querySelector('.flashes');
                    if (flashContainer) flashContainer.innerHTML = ''; // Clear previous messages

                    if (response.ok && data.success) {
                        window.location.href = `/projects/${project_id}`; // Redirect to project view on success
                    } else {
                        if (data.errors) {
                            data.errors.forEach(error => {
                                const li = document.createElement('li');
                                li.className = 'error';
                                li.textContent = error;
                                if (flashContainer) flashContainer.appendChild(li);
                            });
                        } else if (data.message) {
                            const li = document.createElement('li');
                            li.className = 'error';
                            li.textContent = data.message;
                            if (flashContainer) flashContainer.appendChild(li);
                        }
                        if (flashContainer) flashContainer.style.display = 'block';
                    }
                } catch (error) {
                    console.error('Error submitting form:', error);
                    const flashContainer = document.querySelector('.flashes');
                    if (flashContainer) {
                        flashContainer.innerHTML = `<li class="error">An unexpected error occurred.</li>`;
                        flashContainer.style.display = 'block';
                    }
                }
            });
        </script>

        <p><a href="{{ url_for('main.view_project', project_id=project.id) }}">Back to {{ project.name }} Tasks</a></p>
    </main>

    <footer>
        </footer>
</body>
</html>